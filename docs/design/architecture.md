# アーキテクチャ設計書

## 1. システム概要

### 1.1 アーキテクチャパターン
StocksTokは**レイヤードアーキテクチャ**を採用し、以下の層で構成されます：

- **プレゼンテーション層**: Streamlit UI
- **アプリケーション層**: ビジネスロジック
- **ドメイン層**: 分析・評価ロジック
- **インフラストラクチャ層**: データアクセス・外部API

### 1.2 技術スタック
```
フロントエンド: Streamlit
バックエンド: FastAPI
データベース: SQLite
データ処理: pandas, numpy
テクニカル分析: ta-lib, pandas-ta
機械学習: scikit-learn
可視化: plotly, matplotlib
```

## 2. システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    StocksTok System                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Streamlit UI  │    │   FastAPI API   │                │
│  │   (Frontend)    │    │   (Backend)     │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────────────────┼────────────────────────┘
│                                   │
├─────────────────────────────────────────────────────────────┤
│                    Application Layer                        │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  Stock Analyzer │    │  Data Manager   │                │
│  │  (分析エンジン)   │    │  (データ管理)    │                │
│  └─────────────────┘    └─────────────────┘                │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  Cache Manager  │    │  Report Generator│                │
│  │  (キャッシュ管理) │    │  (レポート生成)  │                │
│  └─────────────────┘    └─────────────────┘                │
├─────────────────────────────────────────────────────────────┤
│                     Domain Layer                           │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │ Fundamental     │    │ Technical       │                │
│  │ Analysis        │    │ Analysis        │                │
│  └─────────────────┘    └─────────────────┘                │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │ News Analysis   │    │ ML Engine       │                │
│  │ (ニュース分析)    │    │ (機械学習)      │                │
│  └─────────────────┘    └─────────────────┘                │
├─────────────────────────────────────────────────────────────┤
│                Infrastructure Layer                        │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  Data Access    │    │  External APIs  │                │
│  │  (SQLite)       │    │  (株価・財務)    │                │
│  └─────────────────┘    └─────────────────┘                │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  File Storage   │    │  Logging        │                │
│  │  (履歴・キャッシュ) │    │  (ログ管理)     │                │
│  └─────────────────┘    └─────────────────┘                │
└─────────────────────────────────────────────────────────────┘
```

## 3. レイヤー詳細設計

### 3.1 プレゼンテーション層 (Presentation Layer)

#### 3.1.1 Streamlit UI
- **役割**: ユーザーインターフェース
- **主要コンポーネント**:
  - メインダッシュボード
  - 分析結果表示
  - 設定画面
  - 履歴表示

#### 3.1.2 FastAPI API
- **役割**: バックエンドAPI
- **主要エンドポイント**:
  - `/analyze` - 分析実行
  - `/results` - 結果取得
  - `/history` - 履歴取得
  - `/settings` - 設定管理

### 3.2 アプリケーション層 (Application Layer)

#### 3.2.1 Stock Analyzer
- **役割**: 分析のオーケストレーション
- **主要機能**:
  - 分析フローの制御
  - 各分析モジュールの呼び出し
  - 結果の統合

#### 3.2.2 Data Manager
- **役割**: データの管理・操作
- **主要機能**:
  - データベース操作
  - キャッシュ管理
  - データ検証

#### 3.2.3 Cache Manager
- **役割**: キャッシュ機能の管理
- **主要機能**:
  - データキャッシュ
  - キャッシュ有効期限管理
  - キャッシュ更新判定

#### 3.2.4 Report Generator
- **役割**: レポート生成
- **主要機能**:
  - 分析結果のレポート化
  - 可視化データ生成
  - 履歴レポート生成

### 3.3 ドメイン層 (Domain Layer)

#### 3.3.1 Fundamental Analysis
- **役割**: ファンダメンタルズ分析
- **主要機能**:
  - 財務指標計算
  - 財務健全性評価
  - 収益性評価
  - 成長性評価
  - 配当政策評価

#### 3.3.2 Technical Analysis
- **役割**: テクニカル分析
- **主要機能**:
  - 価格トレンド分析
  - モメンタム指標計算
  - ボラティリティ分析
  - 出来高分析

#### 3.3.3 News Analysis
- **役割**: ニュース・開示分析
- **主要機能**:
  - ニュース感情分析
  - 開示情報重要度評価
  - 業界動向分析

#### 3.3.4 ML Engine
- **役割**: 機械学習機能
- **主要機能**:
  - 予測モデル学習
  - 評価指標最適化
  - パフォーマンス分析

### 3.4 インフラストラクチャ層 (Infrastructure Layer)

#### 3.4.1 Data Access
- **役割**: データベースアクセス
- **主要機能**:
  - SQLite操作
  - データ永続化
  - クエリ最適化

#### 3.4.2 External APIs
- **役割**: 外部API連携
- **主要機能**:
  - 株価データ取得
  - 財務データ取得
  - ニュースデータ取得

#### 3.4.3 File Storage
- **役割**: ファイル管理
- **主要機能**:
  - 履歴ファイル管理
  - キャッシュファイル管理
  - 設定ファイル管理

#### 3.4.4 Logging
- **役割**: ログ管理
- **主要機能**:
  - 実行ログ記録
  - エラーログ記録
  - ログローテーション

## 4. データフロー

### 4.1 分析実行フロー
```
1. ユーザーが分析開始ボタンをクリック
2. Streamlit UI → FastAPI API
3. FastAPI API → Stock Analyzer
4. Stock Analyzer → Data Manager (キャッシュチェック)
5. Data Manager → External APIs (必要データ取得)
6. Stock Analyzer → 各分析モジュール
7. 各分析モジュール → ML Engine (評価計算)
8. Stock Analyzer → Report Generator
9. Report Generator → Data Manager (結果保存)
10. FastAPI API → Streamlit UI (結果返却)
```

### 4.2 データ取得フロー
```
1. 企業リスト取得
2. 各企業の株価データ取得
3. 各企業の財務データ取得
4. 各企業のニュースデータ取得
5. データ検証・クリーニング
6. データベース保存
```

## 5. セキュリティ設計

### 5.1 データセキュリティ
- ローカル環境でのみデータ処理
- 機密データの暗号化
- アクセス制御の実装

### 5.2 APIセキュリティ
- HTTPS通信の使用
- APIキーの安全な管理
- レート制限の実装

## 6. パフォーマンス設計

### 6.1 キャッシュ戦略
- 株価データ: 1日間キャッシュ
- 財務データ: 決算日までキャッシュ
- ニュースデータ: 1時間キャッシュ

### 6.2 並列処理
- 企業データの並列取得
- 分析処理の並列実行
- 非同期処理の活用

## 7. 拡張性設計

### 7.1 機械学習統合
- プラグイン形式でのML機能追加
- モデル管理機能
- 学習データ管理

### 7.2 他市場対応
- 市場別データソース抽象化
- 市場別分析ロジック分離
- 設定による市場切り替え

## 8. エラーハンドリング

### 8.1 エラー分類
- ネットワークエラー
- データ取得エラー
- 分析処理エラー
- システムエラー

### 8.2 エラー対応
- 自動リトライ機能
- 代替データソース利用
- ユーザーへの適切な通知 